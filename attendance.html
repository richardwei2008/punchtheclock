<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, inital-scale=0.5, target-densitydpi=high-dpi, maximum-scale=1, minimum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<title>微考勤</title>
<link href="css/jquery.mobile-1.4.3.min.css" rel="stylesheet" type="text/css"/>
<link href="css/all.css" rel="stylesheet">


	<script src="js/browser-device.js"></script>
	<!-- 大众版 -->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ipbQvdMGPqp2F69G997UVLot"></script>
	<!-- 极速版 
	<script type="text/javascript" src="http://api.map.baidu.com/api?type=quick&ak=ipbQvdMGPqp2F69G997UVLot&v=1.0"></script>
	-->
	<script src="js/jquery-1.11.1.min.js" type="text/javascript"></script>
	<script src="js/jquery.mobile-1.4.3.min.js" type="text/javascript"></script>
	<script src="js/json2.js"></script>
	<script src="js/config.js"></script>
	<script src="js/wechat.common.js"></script>
	<script src="js/beyond.common.js"></script>
	<script>
		// require baidu map 
		var BMapUtils = {
			// 关于状态码
			// BMAP_STATUS_SUCCESS	检索成功。对应数值“0”。
			// BMAP_STATUS_CITY_LIST	城市列表。对应数值“1”。
			// BMAP_STATUS_UNKNOWN_LOCATION	位置结果未知。对应数值“2”。
			// BMAP_STATUS_UNKNOWN_ROUTE	导航结果未知。对应数值“3”。
			// BMAP_STATUS_INVALID_KEY	非法密钥。对应数值“4”。
			// BMAP_STATUS_INVALID_REQUEST	非法请求。对应数值“5”。
			// BMAP_STATUS_PERMISSION_DENIED	没有权限。对应数值“6”。(自 1.1 新增)
			// BMAP_STATUS_SERVICE_UNAVAILABLE	服务不可用。对应数值“7”。(自 1.1 新增)
			// BMAP_STATUS_TIMEOUT	超时。对应数值“8”。(自 1.1 新增)
			getCurrentPositionFailed : function(status){
				var message = "未知错误";
				switch(status) {
					case BMAP_STATUS_SUCCESS:
						message = "检索成功";
						break;
					case BMAP_STATUS_CITY_LIST:
						message = "城市列表";
						break;
					case BMAP_STATUS_UNKNOWN_LOCATION:
						message = "位置结果未知";
						break;
					case BMAP_STATUS_UNKNOWN_ROUTE:
						message = "导航结果未知";
						break;
					case BMAP_STATUS_INVALID_KEY:
						message = "非法密钥";
						break;
					case BMAP_STATUS_INVALID_REQUEST:
						message = "非法请求";
						break;
					case BMAP_STATUS_PERMISSION_DENIED:
						message = "没有权限";
						break;
					case BMAP_STATUS_SERVICE_UNAVAILABLE:
						message = "服务不可用";
						break;
					case BMAP_STATUS_TIMEOUT:
						message = "超时";
						break;
					default:
						break;
				}
				return message;
			},
			getDistance : function(lat_a, lng_a, lat_b, lng_b){
				var pk = 180 / Math.PI;
				var a1 = lat_a / pk;
				var a2 = lng_a / pk;
				var b1 = lat_b / pk;
				var b2 = lng_b / pk;
				var t1 = Math.cos(a1) * Math.cos(a2) * Math.cos(b1) * Math.cos(b2);
				var t2 = Math.cos(a1) * Math.sin(a2) * Math.cos(b1) * Math.sin(b2);
				var t3 = Math.sin(a1) * Math.sin(b1);
				var tt = Math.acos(t1 + t2 + t3);			
				return 6366000 * tt;
			},
			addMyPosition : function (map, p, userIcon){
				// Beyond.alert("To add my location");
				var iconPath = (userIcon === "" ? "images/me.png" : "images/me.png");
				var myIcon = new BMap.Icon(
					iconPath, 
					new BMap.Size(32, 32), 
					{    
						offset: new BMap.Size(0, 0),        
						imageOffset: new BMap.Size(0, 0)   // 设置图片偏移    
					}
				);      
				var mk = new BMap.Marker(p, {icon: myIcon}); 
				map.addOverlay(mk); 
			}
		};
		var WechatUtils = {
			getQueryString : function(name) {  
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");    
				var r = window.location.search.substr(1).match(reg);    
				if (r != null) return unescape(r[2]); 
				return null;
			},
			requireOauth : function(callback) {
				var userInfo = null;
				if (isWeiXin() && !CONFIG.LOCAL) {
					var code = WechatUtils.getQueryString("code");
					Beyond.alert("code " + code);
					$.ajax({
						async: false,       
						url: CONFIG.OAUTH_URL, //这是我的服务端处理文件php的      
						type: "GET",       
						data: {code: code}, // 传递本页面获取的code到后台，以便后台获取openid      
						timeout: 1000,       
						success: function (result) {  
							Beyond.alert("oauth success");		
							Beyond.alert(result);	
							var resultObj = eval(result);
							Beyond.alert(resultObj.result);	
							userInfo = JSON.parse(resultObj.result);							
							callback(userInfo);  							
						},       
						error: function (xhr, textStatus, errorThrown) { 
							Beyond.alert("oauth failed");
							$("#fatalMsg").text(xhr);
							$.mobile.changePage('#fatal', {transition: 'pop', role: 'dialog'});
						}   
					});
				}
				Beyond.alert("return " + JSON.stringify(userInfo));
				return userInfo;
			}
		};
		var App = {
			map : {},
			target : {},
			init : function(){
				App.map = new BMap.Map("bmp");
				App.target = new BMap.Point(CONFIG.LOCATION.COMPANY.lng, CONFIG.LOCATION.COMPANY.lat); // 定位 家
				var marker = new BMap.Marker(App.target); 
				App.map.addOverlay(marker);
				App.map.centerAndZoom(App.target, 25); 
			},
			process : function(p){
				Beyond.alert('您的位置：' + p.lng + ',' + p.lat); 
				Beyond.alert("Now:" + JSON.stringify(p));
				var located = new BMap.Point(p.lng, p.lat); 
				Beyond.alert("D:" + JSON.stringify(App.target));
				var distance = BMapUtils.getDistance(App.target.lat, App.target.lng, p.lat, p.lng);
				Beyond.alert('您的距离（雁荡大厦）：' + distance); // r对象的point属性也是一个对象，这个对象的lng属性表示经度，lat属性表示纬度。
				if (distance > 500) {						
					$("#err_distance").text(Math.ceil(distance));
					$.mobile.changePage('#err', {transition: 'pop', role: 'dialog'});
					return;
				} else if (distance > 200) {
					$("#warn_distance").text(Math.ceil(distance));
					$("#relocate").unbind('click').bind("click", App.punch);
					$("#confirm").unbind('click').bind('click', App.confirmAndSubmit(located));
					$.mobile.changePage('#warn', {transition: 'pop', role: 'dialog'});
					return;
				} else {
					Beyond.alert("accurate");
					App.confirmAndSubmit(located)(this);
					return;
				}
			},
			punch : function () {
				var geolocation = new BMap.Geolocation(); //实例化浏览器定位对象。    
				// 下面是getCurrentPosition方法。调用该对象的getCurrentPosition()，与HTML5不同的是，
				// 这个方法原型是getCurrentPosition(callback:function[, options: PositionOptions])，
				// 也就是说无论成功与否都执行回调函数1，第二个参数是关于位置的选项。 因此能否定位成功需要在回调函数1中自己判断。
				var that = this;
				geolocation.getCurrentPosition(function (r) { //定位结果对象会传递给r变量
					if (this.getStatus() == BMAP_STATUS_SUCCESS) { // 通过Geolocation类的getStatus()可以判断是否成功定位。
						var located = r.point;
						App.process(located);
					} else {
						Beyond.alert('Failed' + BMapUtils.getCurrentPositionFailed(this.getStatus()));
						if (!browser.versions.mobile) {
							Beyond.alert("非移动终端环境，尝试模拟数据定位");
							App.process(CONFIG.MOCKLOCATED.COMPANY);
						}
					}
				}, {
					enableHighAccuracy : true
				});
			},
			confirmAndSubmit : function (located){
				return function() {
					var userInfo = WechatUtils.requireOauth(App.processAfterAuth);
					Beyond.alert(JSON.stringify(userInfo));
					var userIcon = "";
					if (userInfo != null) {
						userIcon = userInfo.headimgurl;
					}
					if (!$.isEmptyObject(userInfo.openid)) {
						BMapUtils.addMyPosition(App.map, located, userIcon);
						$("#punch").text("退    出");
						$("#punch").unbind('click').bind("click", function(){
							window.location.href = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + "/oa.html";
						});	
						alert("签到成功！");
					} else {
						$("#err_distance").text(Math.ceil(distance));
						$("#errMsg").text("获得用户信息失败，无法签到，请重新登陆");
						$.mobile.changePage('#err', {transition: 'pop', role: 'dialog'});
					}
					return;
				}
			},
			processAfterAuth : function (globalUser) { 
				return function(){
					Beyond.alert("processAfterAuth");	
					Beyond.alert("After-authCallback " + JSON.stringify(globalUser));
					 $.ajax({
						async: false,
					 	type : 'POST',
					 	url : "services/save.php",
					 	data : JSON.stringify(globalUser),
					 	dataType : 'json',
					 	success : function (data, textStatus, xhr) {
					 		Beyond.alert("Post-submit (success) " + xhr.responseText);	
							
					 	},
					 	error : function (xhr, textStatus, errorThrown) {							 
							$("#fatalMsg").html(xhr.responseText);
							$.mobile.changePage('#fatal', {transition: 'pop', role: 'dialog'});
						}
					});
				}(this);
				
			}
		}
	</script>
	<script>
	$(window).ready(function () {	
		if(typeof( window.innerWidth ) == 'number' ) {
			//Non-IE
			var myWidth = window.innerWidth;
			var myHeight = window.innerHeight;
		}		
		App.init();  
		$("#punch").unbind('click').bind("click", App.punch);		
		$("#errClose").on("click", App.punch);
		$("#errClose").unbind('click').bind('click',
			function(){
				$('#err').dialog('close');
			}
		);
		$("#infoConfirm").unbind('click').bind('click',
			function(){
				window.location.href = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + "/oa.html";
			}
		);
	});

</script>
 </head>
<body>
<div data-role="page" id="page">
	<!--
	<div data-role="header" data-position="fixed">
		<h1>考勤系统</h1>
	</div>
	-->
	<div data-role="content" data-position="fixed" data-theme="a">	
		<div id="container" >
			<div id="bmp" data-inline="true"></div>
			<div id="control" data-inline="true">
				<button id="punch" class="ui-btn ui-shadow ui-corner-all ui-btn-active" data-mini="true" data-inline="true">打    卡</button>
			</div>
		</div>
	</div>
	<!--
	<div data-role="footer" data-position="fixed">
		<h4>页脚</h4>
	</div>
	-->
</div>

<div data-role="page" id="fatal" data-dismissible="false">
	<div data-role="header">
		<h1><span class="label label-danger">严重错误</span></h1>
	</div>
	<div data-role="content">	
		<div>
			<p><span id="fatalMsg"></span></p>
			<p>无法完成签到，请重新尝试！</p>			
		</div>
		<button class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true" onclick="$('#fatal').dialog('close');">关    闭</button>
	</div>
	<!--
	<div data-role="footer" data-position="fixed">
		<h4>页脚</h4>
	</div>
	-->
</div>
<div data-role="page" id="err" data-dismissible="false">
	<div data-role="header">
		<h1>错    误</h1>
	</div>
	<div data-role="content">	
		<div>
			<p>您所定位的位置与目标（雁荡大厦）相距：<span id="err_distance"></span>米(>500米)</p>
			<p><span id="errMsg">无法完成签到，请重新尝试！</span></p>			
		</div>
		<button id="errClose" class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true">关    闭</button>
	</div>
	<!--
	<div data-role="footer" data-position="fixed">
		<h4>页脚</h4>
	</div>
	-->
</div>
<div data-role="page" id="warn" data-dismissible="false">
	<div data-role="header">
		<h1><span class="label label-warning">警    告</span></h1>
	</div>
	<div data-role="content">	
		<div>
			<p>您所定位的位置与目标（雁荡大厦）相距：<span id="warn_distance"></span>米(>200米)</p>
			<p>是否继续签到？</p>			
		</div> 
		<button id="confirm" class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true" onclick="$('#warn').dialog('close');">签    到</button>
		<button id="relocate" class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true" onclick="$('#warn').dialog('close');">重新定位</button>
		<button class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true" onclick="$('#warn').dialog('close');">退    出</button>
	</div>
	<!--
	<div data-role="footer" data-position="fixed">
		<h4>页脚</h4>
	</div>
	-->
</div>
<div data-role="page" id="info" data-dismissible="false">
	<div data-role="header">
		<h1><span class="label label-info">信    息</span></h1>
	</div>
	<div data-role="content">	
		<div>
			<p><span class="label label-success">签到成功！</span></p>			
			<p>您所定位的位置与目标（雁荡大厦）相距：<span id="warn_distance"></span>米</p>
		</div>
		<button id="infoConfirm" class="ui-btn ui-shadow ui-corner-all" data-mini="true" data-inline="true">确    认</button>
	</div>
	<!--
	<div data-role="footer" data-position="fixed">
		<h4>页脚</h4>
	</div>
	-->
</div>
</body>
</html>